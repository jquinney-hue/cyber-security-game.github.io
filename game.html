<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Defend: Threat Hunter</title>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas for Report Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Firebase Compat SDKs (Provides global 'firebase' namespace) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body { margin: 0; padding: 0; background-color: #1e293b; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .crt-overlay {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 2px 100%;
            pointer-events: none;
        }
        .monitor-frame {
            box-shadow: 0 0 0 10px #333, 0 0 20px 10px rgba(0,0,0,0.5);
            background-color: #0f172a;
        }
        .phone-frame {
            box-shadow: 0 0 0 8px #111, 0 0 15px 5px rgba(0,0,0,0.5);
            background-color: #000;
            border-radius: 30px;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        .glitch { animation: glitch 1s linear infinite; }
        @keyframes glitch { 2%, 64% { transform: translate(2px,0) skew(0deg); } 4%, 60% { transform: translate(-2px,0) skew(0deg); } 62% { transform: translate(0,0) skew(5deg); } }
        
        /* Report Table Styles */
        .report-table th, .report-table td { border: 1px solid #475569; padding: 8px; text-align: left; }
        .report-table th { background-color: #334155; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Firebase Init (Compat) ---
        let auth, db, appId;
        const initFirebase = () => {
            if (typeof window.__firebase_config !== 'undefined' && window.__firebase_config) {
                try {
                    const firebaseConfig = JSON.parse(window.__firebase_config);
                    // Check if already initialized to prevent double init errors
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    auth = firebase.auth();
                    db = firebase.firestore();
                    appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
                    return true;
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    return false;
                }
            }
            return false;
        };
        const firebaseReady = initFirebase();

        // --- Embedded Icons ---
        const IconBase = ({ children, className, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Icons = {
            Monitor: (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></IconBase>,
            Smartphone: (p) => <IconBase {...p}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></IconBase>,
            Mail: (p) => <IconBase {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></IconBase>,
            AlertTriangle: (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>,
            Bug: (p) => <IconBase {...p}><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></IconBase>,
            HardDrive: (p) => <IconBase {...p}><line x1="22" x2="2" y1="12" y2="12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/><line x1="6" x2="6.01" y1="16" y2="16"/><line x1="10" x2="10.01" y1="16" y2="16"/></IconBase>,
            Shield: (p) => <IconBase {...p}><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></IconBase>,
            Wifi: (p) => <IconBase {...p}><path d="M12 20h.01"/><path d="M2 8.82a15 15 0 0 1 20 0"/><path d="M5 12.859a10 10 0 0 1 14 0"/><path d="M8.5 16.429a5 5 0 0 1 7 0"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            Globe: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            Check: (p) => <IconBase {...p}><path d="M20 6 9 17l-5-5"/></IconBase>,
            Trash: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            Activity: (p) => <IconBase {...p}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>
        };

        const { 
            Monitor, Smartphone, Mail, FileText, AlertTriangle, 
            Bug, HardDrive, Shield, Wifi, 
            Lock, Globe, X, Check, Trash, Download, Activity
        } = Icons;

        // --- Game Constants & Data ---

        const ATTACK_TYPES = [
            'Virus', 'Worm', 'Trojan', 'Ransomware', 'Spyware', 
            'Pharming', 'Phishing', 'Pretexting', 'Brute Force'
        ];

        const FILES_INITIAL = [
            { id: 1, name: 'Budget.xlsx', type: 'doc', status: 'safe' },
            { id: 2, name: 'Project_Alpha', type: 'folder', status: 'safe' },
            { id: 3, name: 'Family_Photo.jpg', type: 'img', status: 'safe' },
            { id: 4, name: 'Notes.txt', type: 'doc', status: 'safe' },
        ];

        // --- Helper: Get Today's Key ---
        const getTodayDateString = () => {
            const now = new Date();
            return now.toISOString().split('T')[0]; // YYYY-MM-DD
        };

        const getLocalStorageKey = () => `cyberdefend_stats_${getTodayDateString()}`;

        // --- Components ---

        const Modal = ({ children }) => (
            <div className="absolute inset-0 z-[100] flex items-center justify-center bg-black/70 backdrop-blur-sm">
                <div className="bg-slate-800 p-6 rounded-lg border border-slate-600 shadow-2xl max-w-lg w-full">
                    {children}
                </div>
            </div>
        );

        const App = () => {
            // Game State
            const [gameState, setGameState] = useState('MENU'); // MENU, PLAYING, GAMEOVER
            const [difficulty, setDifficulty] = useState('NORMAL');
            const [money, setMoney] = useState(1000);
            const [integrity, setIntegrity] = useState(100);
            const [gameOverReason, setGameOverReason] = useState(null); // 'FUNDS' or 'INTEGRITY'
            const [score, setScore] = useState(0);
            
            // Stats Tracking State
            const [user, setUser] = useState(null);
            
            // Initialize stats from LocalStorage if available to prevent data loss on refresh
            const [stats, setStats] = useState(() => {
                const key = getLocalStorageKey();
                const saved = localStorage.getItem(key);
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error("Failed to parse local stats", e);
                    }
                }
                return {
                    timePlayed: 0,
                    correct: ATTACK_TYPES.reduce((acc, t) => ({...acc, [t]: 0}), {}),
                    incorrect: ATTACK_TYPES.reduce((acc, t) => ({...acc, [t]: 0}), {})
                };
            });

            const [showReportModal, setShowReportModal] = useState(false);
            const [reporterName, setReporterName] = useState('');
            const reportRef = useRef(null);
            
            // Environment State
            const [files, setFiles] = useState(FILES_INITIAL);
            const [emails, setEmails] = useState([]);
            const [activeWindows, setActiveWindows] = useState([]); // 'browser', 'email', 'chat'
            const [browserUrl, setBrowserUrl] = useState('https://google.com');
            const [browserContent, setBrowserContent] = useState('default');
            const [phoneActive, setPhoneActive] = useState(false); // is ringing?
            const [phoneMessages, setPhoneMessages] = useState([]);
            const [usbInserted, setUsbInserted] = useState(false);
            const [hasUsb, setHasUsb] = useState(false); // DOES USER HAVE A USB DRIVE?
            const [hackerChatOpen, setHackerChatOpen] = useState(false);
            const [ransomwareActive, setRansomwareActive] = useState(false);
            const [bruteForceActive, setBruteForceActive] = useState(false);
            
            // Attack State
            const [currentAttack, setCurrentAttack] = useState(null);
            const [attackSource, setAttackSource] = useState(null); // 'NETWORK', 'USB'
            const [antiMalwareProgress, setAntiMalwareProgress] = useState(0);
            const [isScanning, setIsScanning] = useState(false);
            const [feedback, setFeedback] = useState(null); // { type: 'success'|'error', msg: '' }

            const timerRef = useRef(null);
            const detectionTimeoutRef = useRef(null);
            const wormTimerRef = useRef(null);
            const playTimeRef = useRef(null);

            // --- Firebase Auth & Stats Sync (Refactored for Compat API) ---
            useEffect(() => {
                if (!firebaseReady) return;

                const initAuth = async () => {
                    if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                        await auth.signInWithCustomToken(window.__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                initAuth();

                const unsubscribe = auth.onAuthStateChanged(async (u) => {
                    setUser(u);
                    if (u) {
                        await syncStatsWithCloud(u.uid);
                    }
                });
                return () => unsubscribe();
            }, []);

            const syncStatsWithCloud = async (uid) => {
                const today = getTodayDateString();
                const key = getLocalStorageKey();
                const localData = localStorage.getItem(key);
                
                // Compat syntax: db.collection().doc()
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('daily_stats').doc(today);
                
                try {
                    const snap = await docRef.get();
                    if (snap.exists) {
                        const cloudData = snap.data();
                        // Strategy: If local data exists and has more playtime, trust local. 
                        // Otherwise trust cloud (e.g. new device).
                        if (localData) {
                            const parsedLocal = JSON.parse(localData);
                            if (parsedLocal.timePlayed >= (cloudData.timePlayed || 0)) {
                                // Local is newer or same, keep local state, maybe sync up?
                                // We are already using local state from useState init.
                            } else {
                                // Cloud is newer (played on another device?), update local
                                setStats(cloudData);
                                localStorage.setItem(key, JSON.stringify(cloudData));
                            }
                        } else {
                            // No local data, take cloud data
                            setStats(cloudData);
                            localStorage.setItem(key, JSON.stringify(cloudData));
                        }
                    } else if (localData) {
                        // Cloud Empty, Local Exists -> Push Local to Cloud
                        await docRef.set(JSON.parse(localData));
                    } else {
                        // Both empty -> Initialize in Cloud
                        const initialStats = {
                            timePlayed: 0,
                            correct: ATTACK_TYPES.reduce((acc, t) => ({...acc, [t]: 0}), {}),
                            incorrect: ATTACK_TYPES.reduce((acc, t) => ({...acc, [t]: 0}), {})
                        };
                        await docRef.set(initialStats);
                        // State already initialized to this default
                    }
                } catch (e) {
                    console.error("Error syncing stats:", e);
                }
            };

            const persistStats = (newStats) => {
                // 1. Always save to LocalStorage (Fast, Reliable across refresh)
                const key = getLocalStorageKey();
                localStorage.setItem(key, JSON.stringify(newStats));

                // 2. Sync to Firebase (Best effort)
                if (user && firebaseReady) {
                    const today = getTodayDateString();
                    const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('daily_stats').doc(today);
                    docRef.set(newStats, { merge: true }).catch(e => console.error("FB Save Error", e));
                }
            };

            // --- Integrity Game Over Check ---
            useEffect(() => {
                if (integrity <= 0 && gameState === 'PLAYING') {
                    setGameOverReason('INTEGRITY');
                    endGame();
                }
            }, [integrity, gameState]);

            // --- Play Time Tracking ---
            useEffect(() => {
                if (gameState === 'PLAYING') {
                    playTimeRef.current = setInterval(() => {
                        setStats(prev => {
                            const updated = { ...prev, timePlayed: (prev.timePlayed || 0) + 1 };
                            // Save to local storage every second to ensure time isn't lost on refresh
                            localStorage.setItem(getLocalStorageKey(), JSON.stringify(updated));
                            return updated;
                        });
                    }, 1000);
                } else {
                    clearInterval(playTimeRef.current);
                }
                return () => clearInterval(playTimeRef.current);
            }, [gameState]);


            // --- Game Logic ---

            const startGame = (mode) => {
                setDifficulty(mode);
                setMoney(1000);
                setIntegrity(100);
                setScore(0);
                setGameOverReason(null);
                setGameState('PLAYING');
                setFiles(FILES_INITIAL);
                setEmails([]);
                setPhoneMessages([]);
                setActiveWindows([]);
                setHackerChatOpen(false);
                setRansomwareActive(false);
                setBruteForceActive(false);
                setHasUsb(false);
                setUsbInserted(false);
                setCurrentAttack(null);
                setAttackSource(null);
                setAntiMalwareProgress(0);
                setIsScanning(false);
                
                // Clear any pending timeouts
                if (timerRef.current) clearInterval(timerRef.current);
                if (detectionTimeoutRef.current) clearTimeout(detectionTimeoutRef.current);
                if (wormTimerRef.current) clearInterval(wormTimerRef.current);

                scheduleNextAttack(mode, 1000);
            };

            const getSpeedMultiplier = (currentMoney) => {
                const safeMoney = Math.max(0, currentMoney);
                // Max increase is 150% (total 2.5x) at $15000
                const increase = Math.min(150, Math.floor(safeMoney / 100));
                return 1 + (increase / 100);
            };

            const scheduleNextAttack = (mode, currentMoney) => {
                const baseDelay = mode === 'HARD' ? Math.random() * 5000 + 3000 : Math.random() * 8000 + 5000;
                const multiplier = getSpeedMultiplier(currentMoney);
                const adjustedDelay = baseDelay / multiplier;

                setTimeout(() => {
                    triggerRandomAttack(mode);
                }, adjustedDelay);
            };

            const triggerRandomAttack = (mode) => {
                if (gameState === 'GAMEOVER') return;
                
                // Reset Environment & Replenish Files
                setFiles(prev => {
                    let nextFiles = prev
                        .filter(f => !f.isMalware && f.name !== 'USB_Drive') 
                        .map(f => ({ ...f, status: 'safe' })); 

                    while (nextFiles.length < 4) {
                        const types = ['doc', 'img', 'folder'];
                        const names = ['Notes', 'Budget', 'Photo', 'Work', 'Backup', 'Recipe', 'ToDo', 'System_Log'];
                        const type = types[Math.floor(Math.random() * types.length)];
                        const ext = type === 'folder' ? '' : (type === 'img' ? '.jpg' : '.txt');
                        
                        nextFiles.push({ 
                            id: Date.now() + Math.random(), 
                            name: `${names[Math.floor(Math.random() * names.length)]}_${Math.floor(Math.random()*100)}${ext}`, 
                            type: type, 
                            status: 'safe' 
                        });
                    }
                    return nextFiles;
                });

                setHackerChatOpen(false);
                setRansomwareActive(false);
                setBruteForceActive(false);
                setBrowserContent('default');
                setBrowserUrl('https://google.com');
                setAntiMalwareProgress(0);
                setIsScanning(false);
                setUsbInserted(false);
                setHasUsb(false);

                const type = ATTACK_TYPES[Math.floor(Math.random() * ATTACK_TYPES.length)];
                
                let source = 'NETWORK';
                const usbCapableTypes = ['Virus', 'Worm', 'Trojan', 'Ransomware'];
                if (usbCapableTypes.includes(type) && Math.random() > 0.7) {
                    source = 'USB';
                }
                
                setAttackSource(source);
                setCurrentAttack({ type, timestamp: Date.now() });

                if (source === 'USB') {
                    setHasUsb(true);
                    sendEmail('Device Found', 'Security Alert: An external drive was found. Please examine contents.', false);
                } else {
                    switch (type) {
                        case 'Virus': injectMalwareFile('Holiday_Pics.zip', true); break;
                        case 'Worm': injectMalwareFile('Network_Update.pkg', true); break;
                        case 'Trojan': injectMalwareFile('Free_Ram_Downloader.exe', true); break;
                        case 'Ransomware': injectMalwareFile('Invoice_DEC_2025.pdf', true); break;
                        case 'Spyware': setHackerChatOpen(true); break;
                        case 'Pharming': setBrowserContent('fake'); break;
                        case 'Phishing':
                            if (Math.random() > 0.5) sendEmail('Security Alert', 'BankOfAmerica: Please verify account immediately via link.', true);
                            else sendSms('Amaz0n: Your package is held. Click link to release.', true);
                            break;
                        case 'Pretexting':
                            if (Math.random() > 0.5) sendEmail('Urgent Help Needed', 'Hi, it is your CEO. I am stuck in a meeting and need you to buy Gift Cards immediately.', true);
                            else sendSms('Hey, this is Grandma. I lost my phone in Spain. Please send money for ticket home.', true);
                            break;
                        case 'Brute Force':
                            setBruteForceActive(true);
                            sendEmail('System Admin', 'ALERT: Account Locked. 5,000 failed login attempts detected from IP 192.168.x.x', true);
                            break;
                    }
                }
                
                if (type === 'Worm') {
                    if (wormTimerRef.current) clearInterval(wormTimerRef.current);
                    wormTimerRef.current = setInterval(() => {
                        setFiles(prev => {
                            const hasMalware = prev.some(f => f.isMalware);
                            if (!hasMalware) return prev; 
                            const infectedCount = prev.filter(f => f.status === 'corrupted').length;
                            if (infectedCount < prev.length) {
                                const safeFiles = prev.filter(f => f.status === 'safe' && !f.isMalware);
                                if (safeFiles.length > 0) {
                                    const target = safeFiles[Math.floor(Math.random() * safeFiles.length)];
                                    return prev.map(f => f.id === target.id ? { ...f, status: 'corrupted' } : f);
                                }
                            }
                            return prev;
                        });
                    }, 2000);
                }

                // Delayed Detection Logic
                const detectionDelay = Math.random() * 3000 + 1000;
                
                if (timerRef.current) clearInterval(timerRef.current);
                if (detectionTimeoutRef.current) clearTimeout(detectionTimeoutRef.current);

                detectionTimeoutRef.current = setTimeout(() => {
                    setIsScanning(true);
                    let progress = 0;
                    const speed = mode === 'HARD' ? 1.5 : 0.5;
                    
                    timerRef.current = setInterval(() => {
                        progress += speed;
                        setAntiMalwareProgress(progress);
                        if (progress >= 100) {
                            clearInterval(timerRef.current);
                            if (wormTimerRef.current) clearInterval(wormTimerRef.current);
                            handleAttackTimeout(mode);
                        }
                    }, 100);
                }, detectionDelay);
            };

            const injectMalwareFile = (name, isMalware) => {
                setFiles(prev => [...prev, { 
                    id: Date.now(), 
                    name: name, 
                    type: 'exe', 
                    status: 'safe',
                    isMalware: isMalware 
                }]);
            };

            const sendEmail = (subject, body, isMalicious) => {
                setEmails(prev => [{ id: Date.now(), from: isMalicious ? 'Unknown' : 'System', subject, body, read: false }, ...prev]);
                if (!activeWindows.includes('email')) setActiveWindows(prev => [...prev, 'email']);
            };

            const sendSms = (text, isMalicious) => {
                setPhoneMessages(prev => [...prev, { id: Date.now(), text, sender: 'Unknown' }]);
                setPhoneActive(true);
                setTimeout(() => setPhoneActive(false), 3000);
            };

            const handleFileClick = (file) => {
                if (file.isMalware) {
                    if (currentAttack.type === 'Virus') {
                         setFiles(prev => prev.map(f => f.id !== file.id ? { ...f, status: 'corrupted' } : f));
                    } else if (currentAttack.type === 'Ransomware') {
                        setRansomwareActive(true);
                        setFiles(prev => prev.map(f => ({ ...f, status: 'locked' })));
                    } else if (currentAttack.type === 'Trojan') {
                         setFiles(prev => prev.filter(f => f.id === file.id || Math.random() > 0.5));
                    }
                }
            };

            const handleAttackTimeout = (mode, currentBalance = money, applyPenalty = true) => {
                let finalBalance = currentBalance;
                
                if (applyPenalty) {
                    const penalty = 150;
                    finalBalance -= penalty;
                    setMoney(finalBalance);
                    
                    // Decrease integrity on auto-clean
                    setIntegrity(prev => Math.max(0, prev - 20));

                    setFeedback({ type: 'error', msg: `Anti-Malware Auto-Cleaned System. Service Fee: -$${penalty}` });
                    
                    if (finalBalance <= 0) {
                        setGameOverReason('FUNDS');
                        endGame();
                        persistStats(stats); // Save on game over
                        return;
                    }
                } else {
                     setFeedback({ type: 'info', msg: 'System Reset.' });
                }

                setTimeout(() => setFeedback(null), 3000);
                
                setCurrentAttack(null);
                setAttackSource(null);
                setFiles(prev => prev.filter(f => !f.isMalware && f.status !== 'locked').map(f => ({...f, status: 'safe'})));
                setHackerChatOpen(false);
                setRansomwareActive(false);
                setBruteForceActive(false);
                setUsbInserted(false);
                setHasUsb(false);
                setIsScanning(false);
                
                scheduleNextAttack(mode, finalBalance);
            };

            const submitIdentification = (selectedType) => {
                if (!currentAttack) return;
                
                let newMoney = money;
                let newStats = { ...stats };

                if (selectedType === currentAttack.type) {
                    const reward = difficulty === 'HARD' ? 300 : 200;
                    newMoney += reward;
                    
                    // Increase integrity on correct ID
                    setIntegrity(prev => Math.min(100, prev + 10));

                    setScore(s => s + 1);
                    setFeedback({ type: 'success', msg: `THREAT ELIMINATED: ${selectedType} detected! +$${reward}` });
                    
                    // Update Stats
                    const currentCount = newStats.correct[selectedType] || 0;
                    newStats.correct = { ...newStats.correct, [selectedType]: currentCount + 1 };

                } else {
                    const penalty = difficulty === 'HARD' ? 400 : 300;
                    newMoney -= penalty;
                    
                    // Decrease integrity on mistake
                    setIntegrity(prev => Math.max(0, prev - 25));

                    setFeedback({ type: 'error', msg: `WRONG IDENTIFICATION! System Integrity Damaged. -$${penalty}` });

                    // Update Stats
                    const currentCount = newStats.incorrect[currentAttack.type] || 0;
                    newStats.incorrect = { ...newStats.incorrect, [currentAttack.type]: currentCount + 1 };
                }
                
                setStats(newStats);
                persistStats(newStats); // Persist immediately
                setMoney(newMoney);

                if (newMoney <= 0) {
                    setGameOverReason('FUNDS');
                    endGame();
                    return;
                }

                // Clear logic
                if (timerRef.current) clearInterval(timerRef.current);
                if (detectionTimeoutRef.current) clearTimeout(detectionTimeoutRef.current);
                if (wormTimerRef.current) clearInterval(wormTimerRef.current);
                
                setTimeout(() => setFeedback(null), 2000);
                setCurrentAttack(null);
                setAttackSource(null);
                setFiles(prev => prev.filter(f => !f.isMalware && f.status !== 'locked').map(f => ({...f, status: 'safe'})));
                setHackerChatOpen(false);
                setRansomwareActive(false);
                setBruteForceActive(false);
                setUsbInserted(false);
                setHasUsb(false);
                setIsScanning(false);
                
                scheduleNextAttack(difficulty, newMoney);
            };

            const endGame = () => {
                setGameState('GAMEOVER');
                if (timerRef.current) clearInterval(timerRef.current);
                if (detectionTimeoutRef.current) clearTimeout(detectionTimeoutRef.current);
                if (wormTimerRef.current) clearInterval(wormTimerRef.current);
            };
            
            const deleteEmail = (id) => {
                setEmails(prev => prev.filter(email => email.id !== id));
            };

            const deleteMessage = (id) => {
                setPhoneMessages(prev => prev.filter(msg => msg.id !== id));
            };

            const toggleUsb = () => {
                if (usbInserted) {
                    if (currentAttack && attackSource === 'USB') {
                        const penalty = 300;
                        const newMoney = money - penalty;
                        
                        // Decrease integrity on mistake (wrongful eject)
                        setIntegrity(prev => Math.max(0, prev - 25));

                        setMoney(newMoney);
                        setFeedback({ type: 'error', msg: `THREAT IGNORED! System compromised by USB removal. -$${penalty}` });
                        
                        if (newMoney <= 0) {
                            setGameOverReason('FUNDS');
                            endGame();
                            return;
                        }

                        if (timerRef.current) clearInterval(timerRef.current);
                        if (detectionTimeoutRef.current) clearTimeout(detectionTimeoutRef.current);
                        setTimeout(() => handleAttackTimeout(difficulty, newMoney, false), 1000);
                        return;
                    }

                    setUsbInserted(false);
                    setFiles(prev => prev.filter(f => f.name !== 'USB_Drive'));
                } else {
                    if (hasUsb) {
                        setUsbInserted(true);
                        const isMalicious = (currentAttack && attackSource === 'USB');
                        
                        setFiles(prev => [...prev, {
                            id: Date.now(), 
                            name: 'USB_Drive', 
                            type: 'folder', 
                            status: 'safe',
                            isMalware: isMalicious 
                        }]);
                    } else {
                        setFeedback({ type: 'error', msg: 'You do not have a USB drive to insert.' });
                        setTimeout(() => setFeedback(null), 2000);
                    }
                }
            };

            // --- Report Generation ---
            const handleGenerateReport = async () => {
                if (!reporterName) return;
                
                // Force sync before report
                persistStats(stats);

                // Use html2canvas to capture the hidden report div
                if (reportRef.current) {
                    try {
                        const canvas = await html2canvas(reportRef.current);
                        const dataUrl = canvas.toDataURL("image/png");
                        const link = document.createElement('a');
                        link.href = dataUrl;
                        link.download = `CyberDefend_Report_${getTodayDateString()}.png`;
                        link.click();
                        setShowReportModal(false);
                    } catch (e) {
                        console.error("Report generation failed", e);
                    }
                }
            };

            const formatTime = (seconds) => {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                return `${h}h ${m}m ${s}s`;
            };

            // --- Render Helpers ---

            const gameSpeedMultiplier = Math.round((getSpeedMultiplier(money) - 1) * 100) + 100;

            return (
                <div className="min-h-screen flex flex-col font-sans select-none relative">
                    {/* Header HUD */}
                    <div className="bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center z-10">
                        <div className="flex items-center gap-4">
                            <h1 className="text-xl font-bold text-blue-400 flex items-center gap-2">
                                <Shield className="w-6 h-6" /> Cyber Detective
                            </h1>
                            <div className="flex gap-2">
                                <div className="bg-slate-800 px-3 py-1 rounded text-sm text-slate-300">
                                    Mode: <span className="text-white font-bold">{difficulty}</span>
                                </div>
                                <div className="bg-slate-800 px-3 py-1 rounded text-sm text-yellow-300 flex items-center gap-1">
                                    Speed: <span className="font-bold">{gameSpeedMultiplier}%</span>
                                </div>
                                <div className={`bg-slate-800 px-3 py-1 rounded text-sm flex items-center gap-1 ${integrity < 50 ? 'text-red-400 animate-pulse' : 'text-green-400'}`}>
                                    <Activity className="w-4 h-4" /> Integrity: <span className="font-bold">{integrity}%</span>
                                </div>
                            </div>
                        </div>
                        
                        {/* Anti-Malware Bar */}
                        {currentAttack && (
                            <div className="flex-1 mx-8 max-w-md">
                                <div className="flex justify-between text-xs text-slate-400 mb-1">
                                    <span>
                                        {isScanning ? <span className="text-red-400 animate-pulse font-bold">THREAT DETECTED - SCANNING...</span> : <span className="text-slate-500">System Monitoring...</span>}
                                    </span>
                                    {isScanning && <span>{Math.round(antiMalwareProgress)}%</span>}
                                </div>
                                <div className="h-2 bg-slate-700 rounded-full overflow-hidden relative">
                                    {isScanning ? (
                                        <div 
                                            className="h-full bg-blue-500 transition-all duration-100 ease-linear"
                                            style={{ width: `${antiMalwareProgress}%` }}
                                        ></div>
                                    ) : (
                                        <div className="absolute inset-0 bg-green-900/30 animate-pulse"></div>
                                    )}
                                </div>
                            </div>
                        )}

                        <div className="flex items-center gap-6">
                             <button 
                                onClick={() => setShowReportModal(true)}
                                className="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded text-xs flex items-center gap-1 transition"
                            >
                                <Download className="w-3 h-3" /> Report
                            </button>
                            <div className="text-right">
                                <div className="text-xs text-slate-400">Funds</div>
                                <div className={`text-xl font-mono font-bold ${money < 300 ? 'text-red-500' : 'text-green-400'}`}>
                                    ${money}
                                </div>
                            </div>
                            <button 
                                onClick={() => setGameState('MENU')}
                                className="p-2 hover:bg-slate-800 rounded text-slate-400"
                            >
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                    </div>

                    {/* Report Modal */}
                    {showReportModal && (
                        <Modal>
                            <div className="space-y-4">
                                <h2 className="text-2xl font-bold text-blue-400">Generate Performance Report</h2>
                                <p className="text-slate-300 text-sm">Enter your name to sign the daily report.</p>
                                <input 
                                    type="text" 
                                    value={reporterName}
                                    onChange={(e) => setReporterName(e.target.value)}
                                    placeholder="Agent Name" 
                                    className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white outline-none focus:border-blue-500"
                                />
                                <div className="flex gap-2 justify-end mt-4">
                                    <button onClick={() => setShowReportModal(false)} className="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                                    <button onClick={handleGenerateReport} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded font-bold">Download PNG</button>
                                </div>
                            </div>
                        </Modal>
                    )}

                    {/* Hidden Report Container for html2canvas */}
                    {/* Changed from opacity-0 to off-screen positioning to ensure rendering for screenshot */}
                    <div className="fixed top-0 -left-[2000px] pointer-events-none">
                        <div ref={reportRef} className="w-[800px] bg-slate-900 p-8 text-white font-sans border-4 border-slate-700">
                            <div className="flex justify-between items-center border-b-2 border-slate-600 pb-4 mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold text-blue-400 flex items-center gap-2"><Shield className="w-8 h-8"/> CYBER DEFENSE REPORT</h1>
                                    <p className="text-slate-400">Daily Threat Analysis Log</p>
                                </div>
                                <div className="text-right">
                                    <div className="text-xl font-bold">{reporterName || 'Unknown Agent'}</div>
                                    <div className="text-sm text-slate-400">{getTodayDateString()}</div>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-8 mb-8">
                                <div className="bg-slate-800 p-4 rounded border border-slate-600">
                                    <div className="text-slate-400 text-sm">Time Active</div>
                                    <div className="text-3xl font-mono">{formatTime(stats.timePlayed)}</div>
                                </div>
                                <div className="bg-slate-800 p-4 rounded border border-slate-600">
                                    <div className="text-slate-400 text-sm">Current Funds</div>
                                    <div className="text-3xl font-mono text-green-400">${money}</div>
                                </div>
                            </div>

                            {/* Removed 'collapse' class which was hiding the table */}
                            <table className="w-full report-table text-sm border-collapse">
                                <thead>
                                    <tr>
                                        <th className="w-1/3">Threat Type</th>
                                        <th className="text-center text-green-400">Correctly Identified</th>
                                        <th className="text-center text-red-400">Incorrectly Identified</th>
                                        <th className="text-center">Accuracy</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {ATTACK_TYPES.map(type => {
                                        const c = stats.correct[type] || 0;
                                        const i = stats.incorrect[type] || 0;
                                        const total = c + i;
                                        const acc = total > 0 ? Math.round((c / total) * 100) : 0;
                                        return (
                                            <tr key={type} className="bg-slate-800">
                                                <td>{type}</td>
                                                <td className="text-center font-bold">{c}</td>
                                                <td className="text-center text-red-300">{i}</td>
                                                <td className="text-center text-slate-400">{total > 0 ? acc + '%' : '-'}</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            <div className="mt-8 text-center text-slate-500 text-xs uppercase tracking-widest">Confidential Document â€¢ CyberDefend Security Systems</div>
                        </div>
                    </div>

                    {/* Feedback Toast */}
                    {feedback && (
                        <div className={`absolute top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-xl border z-50 animate-bounce
                            ${feedback.type === 'success' ? 'bg-green-900/90 border-green-500 text-green-100' : 
                              feedback.type === 'error' ? 'bg-red-900/90 border-red-500 text-red-100' : 
                              'bg-blue-900/90 border-blue-500 text-blue-100'}`}>
                            {feedback.msg}
                        </div>
                    )}

                    {/* Main Game Area */}
                    <div className="flex-1 p-6 flex gap-6 overflow-hidden bg-slate-900 relative">
                        
                        {/* MAIN MENU OVERLAY */}
                        {gameState === 'MENU' && (
                            <Modal>
                                <div className="text-center space-y-6">
                                    <h2 className="text-3xl font-bold text-blue-400">Cyber Defense Simulator</h2>
                                    <p className="text-slate-300">
                                        Identify malware and social engineering attacks before the system auto-deletes them.
                                        <br/><br/>
                                        <span className="text-green-400">Correct ID: +$200</span><br/>
                                        <span className="text-red-400">Wrong ID: -$300</span><br/>
                                        <span className="text-orange-400">Auto-Clean Fee: -$150</span>
                                    </p>
                                    <div className="space-y-3">
                                        <button onClick={() => startGame('NORMAL')} className="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded font-bold transition">Normal Mode</button>
                                        <button onClick={() => startGame('HARD')} className="w-full py-3 bg-red-600 hover:bg-red-500 rounded font-bold transition">Hard Mode</button>
                                    </div>
                                </div>
                            </Modal>
                        )}

                        {/* GAME OVER OVERLAY */}
                        {gameState === 'GAMEOVER' && (
                            <Modal>
                                <div className="text-center space-y-6">
                                    <h2 className="text-3xl font-bold text-red-500">SYSTEM COMPROMISED</h2>
                                    <p className="text-xl">
                                        {gameOverReason === 'INTEGRITY' ? 'System Integrity Critical (0%)' : 'Insufficient Funds'}
                                    </p>
                                    <p className="text-slate-400">Total Score: {score}</p>
                                    <button onClick={() => setGameState('MENU')} className="w-full py-3 bg-slate-600 hover:bg-slate-500 rounded font-bold transition">Return to Menu</button>
                                </div>
                            </Modal>
                        )}

                        {/* DESKTOP MONITOR */}
                        <div className="flex-grow relative flex flex-col">
                            <div className="monitor-frame flex-1 rounded-t-lg relative overflow-hidden flex flex-col">
                                {/* Screen Content */}
                                <div className="flex-1 relative bg-slate-800 p-4">
                                    
                                    {/* Desktop Icons */}
                                    <div className="grid grid-cols-4 gap-4 w-64 absolute top-4 left-4 z-0">
                                        {files.map(file => (
                                            <div 
                                                key={file.id} 
                                                onClick={() => handleFileClick(file)}
                                                className="flex flex-col items-center gap-1 p-2 hover:bg-white/10 rounded cursor-pointer group"
                                            >
                                                <div className="relative">
                                                    {file.type === 'folder' ? <div className="text-yellow-400"><FileText className="w-10 h-10 fill-yellow-500"/></div> : 
                                                     file.type === 'img' ? <div className="text-purple-400"><FileText className="w-10 h-10"/></div> :
                                                     <div className="text-blue-400"><FileText className="w-10 h-10"/></div>}
                                                    
                                                    {file.isMalware && (
                                                        <div className="absolute -top-1 -right-1 bg-green-500 rounded-full p-0.5 animate-pulse">
                                                            <Bug className="w-3 h-3 text-black" />
                                                        </div>
                                                    )}
                                                    {file.status === 'corrupted' && (
                                                        <div className="absolute inset-0 bg-red-500/50 rounded flex items-center justify-center">
                                                            <AlertTriangle className="w-6 h-6 text-white" />
                                                        </div>
                                                    )}
                                                    {file.status === 'locked' && (
                                                        <div className="absolute inset-0 bg-slate-900/80 rounded flex items-center justify-center">
                                                            <Lock className="w-6 h-6 text-red-500" />
                                                        </div>
                                                    )}
                                                </div>
                                                <span className={`text-xs text-center truncate w-full ${file.status === 'corrupted' ? 'text-red-400' : 'text-slate-200'}`}>{file.name}</span>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Ransomware Overlay */}
                                    {ransomwareActive && (
                                        <div className="absolute inset-0 z-40 bg-red-900/90 flex flex-col items-center justify-center text-center p-8 glitch">
                                            <Lock className="w-24 h-24 text-white mb-4" />
                                            <h2 className="text-4xl font-bold text-white mb-2">YOUR FILES ARE ENCRYPTED</h2>
                                            <p className="text-red-200 mb-6">Send 5 BTC to UnLock your data. Attempts to remove will result in deletion.</p>
                                        </div>
                                    )}

                                    {/* Brute Force Overlay */}
                                    {bruteForceActive && (
                                        <div className="absolute top-4 right-4 z-40 bg-red-600 text-white p-4 rounded shadow-lg w-64 animate-pulse">
                                            <div className="flex items-center gap-2 mb-2 font-bold"><AlertTriangle className="w-5 h-5"/> SECURITY ALERT</div>
                                            <p className="text-sm">Account Locked. Maximum login attempts exceeded (5000+).</p>
                                        </div>
                                    )}

                                    {/* Spyware Chat Window */}
                                    {hackerChatOpen && (
                                        <div className="absolute bottom-16 right-4 w-64 bg-black border border-green-500 rounded-t-lg shadow-2xl z-20 font-mono text-sm">
                                            <div className="bg-green-900 px-3 py-1 text-green-100 flex justify-between items-center">
                                                <span>Anonymous</span>
                                                <X className="w-4 h-4 cursor-pointer" onClick={() => setHackerChatOpen(false)}/>
                                            </div>
                                            <div className="p-3 h-40 bg-black text-green-500 overflow-y-auto">
                                                <p className="mb-2">&gt; I see you checking your email...</p>
                                                <p className="mb-2">&gt; Nice bank balance.</p>
                                                <p>&gt; Don't try to hide.</p>
                                            </div>
                                            <div className="p-2 border-t border-green-800">
                                                <input disabled type="text" placeholder="Type..." className="w-full bg-black text-green-700 outline-none" />
                                            </div>
                                        </div>
                                    )}

                                    {/* Browser Window */}
                                    {activeWindows.includes('browser') && (
                                        <div className="absolute top-10 left-10 w-3/4 h-3/4 bg-white text-black rounded-lg shadow-2xl flex flex-col z-10 overflow-hidden">
                                            <div className="bg-slate-200 p-2 flex items-center gap-2 border-b border-slate-300">
                                                <div className="flex gap-1">
                                                    <div className="w-3 h-3 rounded-full bg-red-500 cursor-pointer" onClick={() => setActiveWindows(prev => prev.filter(w => w !== 'browser'))}></div>
                                                    <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
                                                    <div className="w-3 h-3 rounded-full bg-green-500"></div>
                                                </div>
                                                <div className="flex-1 bg-white rounded px-2 py-1 text-sm text-slate-600 flex items-center">
                                                    <Lock className="w-3 h-3 mr-1" />
                                                    {currentAttack?.type === 'Pharming' ? 
                                                        (browserContent === 'fake' ? 'https://g00gle.com/prize' : 'https://google.com') 
                                                        : 'https://google.com'}
                                                </div>
                                            </div>
                                            <div className="flex-1 p-4 bg-white relative">
                                                {/* Simulated Content */}
                                                {currentAttack?.type === 'Pharming' ? (
                                                    <div className="flex flex-col items-center justify-center h-full space-y-4">
                                                        <h1 className="text-4xl font-bold text-blue-600">G00gle</h1>
                                                        <div className="bg-yellow-100 border-2 border-yellow-400 p-6 rounded text-center animate-bounce">
                                                            <h2 className="text-xl font-bold text-red-600">CONGRATULATIONS!</h2>
                                                            <p>You have won a free iPad!</p>
                                                            <button className="mt-2 bg-green-500 text-white px-4 py-2 rounded">CLAIM NOW</button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                     <div className="flex flex-col items-center justify-center h-full space-y-4 text-slate-300">
                                                        <h1 className="text-4xl font-bold text-slate-400">Google</h1>
                                                        <input type="text" className="border border-slate-300 rounded-full px-4 py-2 w-1/2" placeholder="Search" />
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* Email Window */}
                                    {activeWindows.includes('email') && (
                                        <div className="absolute top-14 left-14 w-3/4 h-3/4 bg-slate-100 text-black rounded-lg shadow-2xl flex flex-col z-20 overflow-hidden">
                                            <div className="bg-blue-600 p-2 flex justify-between items-center text-white">
                                                <span className="text-sm font-bold flex items-center gap-2"><Mail className="w-4 h-4"/> Inbox ({emails.length})</span>
                                                <X className="w-4 h-4 cursor-pointer" onClick={() => setActiveWindows(prev => prev.filter(w => w !== 'email'))}/>
                                            </div>
                                            <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                                {emails.map(email => (
                                                    <div key={email.id} className="bg-white p-3 rounded border border-slate-200 shadow-sm relative group">
                                                        {currentAttack && email.from === 'Unknown' && (
                                                            <div className="absolute top-2 right-8 text-green-500"><Bug className="w-4 h-4"/></div>
                                                        )}
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); deleteEmail(email.id); }}
                                                            className="absolute top-2 right-2 text-slate-400 hover:text-red-500 p-1"
                                                            title="Delete Email"
                                                        >
                                                            <Trash className="w-4 h-4" />
                                                        </button>
                                                        <div className="font-bold text-sm text-slate-800 pr-8">{email.subject}</div>
                                                        <div className="text-xs text-slate-500 mb-1">From: {email.from}</div>
                                                        <div className="text-sm text-slate-700">{email.body}</div>
                                                    </div>
                                                ))}
                                                {emails.length === 0 && <div className="text-center text-slate-400 mt-10">No new mail</div>}
                                            </div>
                                        </div>
                                    )}

                                </div>
                                {/* Taskbar */}
                                <div className="bg-slate-900 p-2 flex items-center gap-4 z-30 border-t border-slate-700">
                                    <button className="p-2 hover:bg-slate-700 rounded text-blue-400" onClick={() => setActiveWindows(prev => [...prev, 'browser'])}>
                                        <Globe className="w-6 h-6" />
                                    </button>
                                    <button className="p-2 hover:bg-slate-700 rounded text-yellow-400" onClick={() => setActiveWindows(prev => [...prev, 'email'])}>
                                        <Mail className="w-6 h-6" />
                                    </button>
                                    <div className="ml-auto text-xs text-slate-500 font-mono">10:42 AM</div>
                                </div>
                            </div>
                            {/* Monitor Stand */}
                            <div className="h-8 bg-slate-800 w-1/3 mx-auto rounded-b-lg mb-2"></div>
                            <div className="h-2 bg-slate-700 w-1/2 mx-auto rounded-full"></div>
                        </div>

                        {/* RIGHT SIDE PANEL */}
                        <div className="w-80 flex flex-col gap-6">
                            
                            {/* PHONE */}
                            <div className={`phone-frame h-96 p-3 relative flex flex-col ${phoneActive ? 'shake' : ''}`}>
                                <div className="w-20 h-4 bg-black absolute top-0 left-1/2 -translate-x-1/2 rounded-b-xl z-20"></div>
                                <div className="flex-1 bg-zinc-900 rounded-2xl overflow-hidden relative text-white flex flex-col">
                                    {/* Status Bar */}
                                    <div className="flex justify-between px-3 py-1 text-[10px] text-zinc-400">
                                        <span>10:42</span>
                                        <div className="flex gap-1"><Wifi className="w-3 h-3"/><div className="w-3 h-3 bg-green-500 rounded-full text-[8px] flex items-center justify-center">âš¡</div></div>
                                    </div>
                                    
                                    {/* Phone Content */}
                                    <div className="flex-1 p-3 overflow-y-auto">
                                        {phoneActive ? (
                                            <div className="h-full flex flex-col items-center justify-center space-y-4">
                                                <div className="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center animate-ping">
                                                    <Smartphone className="w-8 h-8" />
                                                </div>
                                                <div className="text-center">
                                                    <h3 className="text-xl">Incoming Call</h3>
                                                    <p className="text-slate-400">Unknown Number</p>
                                                </div>
                                                <div className="flex gap-4">
                                                    <button className="bg-red-500 p-3 rounded-full"><X className="w-6 h-6"/></button>
                                                    <button className="bg-green-500 p-3 rounded-full"><Check className="w-6 h-6"/></button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                <h3 className="text-lg font-bold border-b border-zinc-700 pb-2">Messages</h3>
                                                {phoneMessages.map(msg => (
                                                    <div key={msg.id} className="bg-zinc-800 p-3 rounded-lg text-sm relative group">
                                                        <div className="flex justify-between items-start mb-1">
                                                            <div className="text-xs text-blue-400">{msg.sender}</div>
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); deleteMessage(msg.id); }}
                                                                className="text-zinc-500 hover:text-red-400 p-0.5"
                                                            >
                                                                <Trash className="w-3 h-3" />
                                                            </button>
                                                        </div>
                                                        <div className="pr-4">{msg.text}</div>
                                                        {currentAttack && <div className="absolute bottom-1 right-1 bg-green-500 w-2 h-2 rounded-full"></div>}
                                                    </div>
                                                ))}
                                                {phoneMessages.length === 0 && <div className="text-center text-zinc-600 mt-10">No messages</div>}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="h-1 w-1/3 bg-white/20 mx-auto rounded-full mt-2"></div>
                            </div>

                            {/* USB DRIVE & CONTROLS */}
                            <div className="bg-slate-800 p-4 rounded-lg border border-slate-700 space-y-4">
                                <div 
                                    className={`p-3 rounded border-2 border-dashed flex items-center justify-center cursor-pointer transition ${
                                        usbInserted 
                                        ? 'border-green-500 bg-green-900/20' 
                                        : hasUsb 
                                            ? 'border-blue-500 hover:border-blue-400 animate-pulse' 
                                            : 'border-slate-700 opacity-50 cursor-not-allowed'
                                    }`}
                                    onClick={toggleUsb}
                                >
                                    <HardDrive className={`w-5 h-5 mr-2 ${usbInserted ? 'text-green-400' : 'text-slate-400'}`} />
                                    <span className="text-sm font-bold text-slate-300">
                                        {usbInserted ? 'Eject USB Drive' : (hasUsb ? 'Insert USB Drive' : 'No USB Drive')}
                                    </span>
                                </div>
                            </div>

                            {/* IDENTIFY BUTTON - CORE MECHANIC */}
                            <div className="bg-slate-800 p-4 rounded-lg border border-slate-700 flex flex-col gap-2">
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">Threat Analysis</h3>
                                <div className="grid grid-cols-2 gap-2">
                                    {ATTACK_TYPES.map(type => (
                                        <button 
                                            key={type}
                                            onClick={() => submitIdentification(type)}
                                            className="px-2 py-2 bg-slate-700 hover:bg-blue-600 text-xs rounded text-left transition truncate"
                                        >
                                            {type}
                                        </button>
                                    ))}
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    {/* CRT Effect Overlay */}
                    <div className="fixed inset-0 crt-overlay pointer-events-none z-50"></div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
